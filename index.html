<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adaptive Learning Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            max-width: 900px;
            width: 100%;
        }
        .badge-icon {
            font-size: 2.5rem;
        }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="container bg-white p-8 rounded-2xl shadow-xl border border-gray-200">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-8">Adaptive Learning Tracker</h1>
        
        <!-- Login Section -->
        <div id="loginSection" class="p-6 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Student Login</h2>
            <div class="space-y-4">
                <input type="text" id="studentNameInput" placeholder="Enter Your Full Name" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="classNameInput" placeholder="Enter Your Class (e.g., 10th-A)" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="loginBtn" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                    Start Learning
                </button>
            </div>
            <p id="authStatus" class="mt-4 text-center text-gray-500 text-sm">Authenticating...</p>
        </div>

        <!-- Main Tracker Section (Initially Hidden) -->
        <div id="trackerSection" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <div class="text-lg font-medium text-gray-600">
                    <span id="welcomeName"></span>
                    <span id="welcomeClass" class="text-sm text-gray-400"></span>
                </div>
                <button id="logoutBtn" class="text-sm text-gray-500 hover:text-red-500 transition-colors">Log Out</button>
            </div>

            <!-- Quiz & Tracker Section -->
            <div class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
                <h2 class="text-2xl font-semibold text-blue-800 mb-4">Take a Quiz</h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <select id="topicInput" class="flex-grow p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Topic</option>
                        <option value="Physics">Physics</option>
                        <option value="Chemistry">Chemistry</option>
                        <option value="Biology">Biology</option>
                        <option value="History">History</option>
                    </select>
                    <button id="startQuizBtn" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200" disabled>
                        Start Quiz
                    </button>
                </div>
            </div>

            <div class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Quiz Performance Summary</h2>
                <div id="summaryContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Summary will be injected here -->
                </div>
            </div>
    
            <!-- Revision Suggestions Section -->
            <div class="p-6 bg-yellow-50 rounded-lg border border-yellow-200">
                <h2 class="text-2xl font-semibold text-yellow-800 mb-4">Suggested Topics for Revision</h2>
                <ul id="revisionList" class="list-disc pl-5 space-y-2">
                    <!-- Revision topics will be injected here -->
                </ul>
            </div>
        </div>

        <!-- Quiz Section (Initially Hidden) -->
        <div id="quizSection" class="hidden">
            <h2 id="quizTopicTitle" class="text-2xl font-bold text-center text-gray-800 mb-6"></h2>
            <form id="quizForm" class="space-y-6">
                <!-- Quiz questions will be dynamically added here -->
            </form>
            <div id="quizResults" class="hidden mt-8 text-center p-6 rounded-lg shadow-md">
                <p class="text-2xl font-semibold text-gray-700 mb-4">Your Score: <span id="quizScoreDisplay" class="font-bold text-green-600"></span></p>
                <button id="backToDashboardBtn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200 mt-4">Back to Dashboard</button>
                <button id="reviewMistakesBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 mt-4">Review Mistakes</button>
                <button id="saveScoreBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 mt-4">Save Score to Tracker</button>
            </div>
        </div>

        <!-- Review and Follow-up Quiz Section (Initially Hidden) -->
        <div id="reviewSection" class="hidden">
            <h2 id="reviewTitle" class="text-2xl font-bold text-center text-gray-800 mb-6"></h2>
            <div id="reviewContentContainer">
                <!-- Mistakes and follow-up quizzes will be dynamically added here -->
            </div>
            <div class="mt-8 text-center">
                <button id="backFromReviewBtn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">Back to Dashboard</button>
            </div>
        </div>


        <!-- Message Box for Alerts -->
        <div id="messageBox" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                <p id="messageText" class="text-lg font-medium text-gray-800 mb-4"></p>
                <button id="messageCloseBtn" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level for debugging
        setLogLevel('debug');

        // Global variables for Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // DOM elements
        const loginSection = document.getElementById('loginSection');
        const trackerSection = document.getElementById('trackerSection');
        const studentNameInput = document.getElementById('studentNameInput');
        const classNameInput = document.getElementById('classNameInput');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authStatus = document.getElementById('authStatus');
        const welcomeName = document.getElementById('welcomeName');
        const welcomeClass = document.getElementById('welcomeClass');
        const topicInput = document.getElementById('topicInput');
        const startQuizBtn = document.getElementById('startQuizBtn');
        const summaryContainer = document.getElementById('summaryContainer');
        const revisionList = document.getElementById('revisionList');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageCloseBtn = document.getElementById('messageCloseBtn');

        const quizSection = document.getElementById('quizSection');
        const quizTopicTitle = document.getElementById('quizTopicTitle');
        const quizForm = document.getElementById('quizForm');
        const quizResults = document.getElementById('quizResults');
        const quizScoreDisplay = document.getElementById('quizScoreDisplay');
        const backToDashboardBtn = document.getElementById('backToDashboardBtn');
        const reviewMistakesBtn = document.getElementById('reviewMistakesBtn');
        const saveScoreBtn = document.getElementById('saveScoreBtn');

        const reviewSection = document.getElementById('reviewSection');
        const reviewTitle = document.getElementById('reviewTitle');
        const reviewContentContainer = document.getElementById('reviewContentContainer');
        const backFromReviewBtn = document.getElementById('backFromReviewBtn');

        let userProfileRef;
        let userId;
        let userProfile = {};
        const REVISION_THRESHOLD = 70;
        let currentQuizScore = 0;
        let currentQuizTopic = '';
        let currentQuizAttempt = [];
        let hintGiven = false;

        // Hard-coded quiz data
        const quizData = {
            "Physics": [
                {
                    "subtopic": "Motion",
                    "question": "What is the speed of an object that travels 100 meters in 10 seconds?",
                    "answerOptions": [
                        {"text": "10 m/s", "rationale": "Speed is calculated as distance divided by time (100m / 10s = 10m/s).", "isCorrect": true},
                        {"text": "1000 m/s", "rationale": "This would be the product of distance and time.", "isCorrect": false},
                        {"text": "100 m/s", "rationale": "This is just the distance.", "isCorrect": false},
                        {"text": "10 s/m", "rationale": "The units are incorrect for speed.", "isCorrect": false}
                    ],
                    "hint": "Speed is distance divided by time."
                },
                {
                    "subtopic": "Energy",
                    "question": "Which form of energy is stored in a stretched rubber band?",
                    "answerOptions": [
                        {"text": "Kinetic energy", "rationale": "Kinetic energy is the energy of motion.", "isCorrect": false},
                        {"text": "Thermal energy", "rationale": "Thermal energy is related to heat.", "isCorrect": false},
                        {"text": "Potential energy", "rationale": "A stretched rubber band has potential energy, specifically elastic potential energy.", "isCorrect": true},
                        {"text": "Chemical energy", "rationale": "Chemical energy is stored in the bonds of atoms and molecules.", "isCorrect": false}
                    ],
                    "hint": "This type of energy is stored and ready to be released."
                },
                {
                    "subtopic": "Waves",
                    "question": "What is the term for the height of a wave from its resting position?",
                    "answerOptions": [
                        {"text": "Frequency", "rationale": "Frequency is the number of waves that pass a point per second.", "isCorrect": false},
                        {"text": "Wavelength", "rationale": "Wavelength is the distance between two consecutive peaks or troughs.", "isCorrect": false},
                        {"text": "Amplitude", "rationale": "Amplitude is the maximum displacement or distance moved by a point on a vibrating body or wave measured from its equilibrium position.", "isCorrect": true},
                        {"text": "Speed", "rationale": "Wave speed is how fast the wave travels.", "isCorrect": false}
                    ],
                    "hint": "Think of how loud a sound wave is, or how tall an ocean wave is."
                },
                {
                    "subtopic": "Electricity",
                    "question": "Which material is a good electrical conductor?",
                    "answerOptions": [
                        {"text": "Rubber", "rationale": "Rubber is an electrical insulator.", "isCorrect": false},
                        {"text": "Glass", "rationale": "Glass is an electrical insulator.", "isCorrect": false},
                        {"text": "Wood", "rationale": "Wood is an electrical insulator.", "isCorrect": false},
                        {"text": "Copper", "rationale": "Copper is a common material used in electrical wires because it is a very good conductor.", "isCorrect": true}
                    ],
                    "hint": "This is a type of metal often found in wires."
                },
                {
                    "subtopic": "Light",
                    "question": "When light passes from air into water, it bends. What is this phenomenon called?",
                    "answerOptions": [
                        {"text": "Reflection", "rationale": "Reflection is when light bounces off a surface.", "isCorrect": false},
                        {"text": "Refraction", "rationale": "Refraction is the bending of light as it passes from one medium to another.", "isCorrect": true},
                        {"text": "Dispersion", "rationale": "Dispersion is the separation of light into its different colors.", "isCorrect": false},
                        {"text": "Diffraction", "rationale": "Diffraction is the spreading of light as it passes through an opening or around an obstacle.", "isCorrect": false}
                    ],
                    "hint": "This is why a pencil in a glass of water looks broken."
                },
                {
                    "subtopic": "Force",
                    "question": "What is the force that opposes motion between two surfaces in contact?",
                    "answerOptions": [
                        {"text": "Gravity", "rationale": "Gravity is the force of attraction between masses.", "isCorrect": false},
                        {"text": "Magnetism", "rationale": "Magnetism is a force exerted by magnets or moving electric charges.", "isCorrect": false},
                        {"text": "Friction", "rationale": "Friction is the force that resists motion when two surfaces are in contact.", "isCorrect": true},
                        {"text": "Tension", "rationale": "Tension is the pulling force exerted by a string, cable, or chain.", "isCorrect": false}
                    ],
                    "hint": "This is the force that makes it hard to slide a heavy box across the floor."
                },
                {
                    "subtopic": "Thermodynamics",
                    "question": "What is the process of a liquid turning into a solid?",
                    "answerOptions": [
                        {"text": "Melting", "rationale": "Melting is the process of a solid becoming a liquid.", "isCorrect": false},
                        {"text": "Boiling", "rationale": "Boiling is the process of a liquid becoming a gas at a specific temperature.", "isCorrect": false},
                        {"text": "Freezing", "rationale": "Freezing is the process of a liquid becoming a solid, which is the opposite of melting.", "isCorrect": true},
                        {"text": "Condensation", "rationale": "Condensation is the process of a gas becoming a liquid.", "isCorrect": false}
                    ],
                    "hint": "Think of what happens to water when it gets very cold."
                },
                {
                    "subtopic": "Sound",
                    "question": "How is the pitch of a sound determined?",
                    "answerOptions": [
                        {"text": "By its amplitude.", "rationale": "The amplitude of a sound wave determines its loudness.", "isCorrect": false},
                        {"text": "By its wavelength.", "isCorrect": false},
                        {"text": "By its speed.", "rationale": "The speed of sound is constant in a given medium.", "isCorrect": false},
                        {"text": "By its frequency.", "rationale": "The pitch of a sound is determined by the frequency of the sound wave. Higher frequency means higher pitch.", "isCorrect": true}
                    ],
                    "hint": "This is related to how many waves pass a point in a second."
                },
                {
                    "subtopic": "Magnetism",
                    "question": "Which of these materials is magnetic?",
                    "answerOptions": [
                        {"text": "Aluminum", "rationale": "Aluminum is not a magnetic material.", "isCorrect": false},
                        {"text": "Plastic", "rationale": "Plastic is not magnetic.", "isCorrect": false},
                        {"text": "Iron", "rationale": "Iron, cobalt, and nickel are common magnetic materials.", "isCorrect": true},
                        {"text": "Glass", "rationale": "Glass is not magnetic.", "isCorrect": false}
                    ],
                    "hint": "This is a common metal used in many tools."
                },
                {
                    "subtopic": "Motion",
                    "question": "What is acceleration?",
                    "answerOptions": [
                        {"text": "The rate of change of speed.", "isCorrect": false},
                        {"text": "The total distance an object travels.", "rationale": "This is distance.", "isCorrect": false},
                        {"text": "The rate of change of velocity.", "rationale": "Acceleration is a vector quantity defined as the rate at which an object changes its velocity.", "isCorrect": true},
                        {"text": "The total time it takes for an object to travel.", "rationale": "This is time.", "isCorrect": false}
                    ],
                    "hint": "This is what happens when a car speeds up or slows down."
                },
                {
                    "subtopic": "Energy",
                    "question": "What type of energy is possessed by a moving object?",
                    "answerOptions": [
                        {"text": "Potential energy", "rationale": "Potential energy is stored energy.", "isCorrect": false},
                        {"text": "Kinetic energy", "rationale": "Kinetic energy is the energy of motion.", "isCorrect": true},
                        {"text": "Thermal energy", "rationale": "Thermal energy is related to heat.", "isCorrect": false},
                        {"text": "Chemical energy", "rationale": "Chemical energy is stored in bonds.", "isCorrect": false}
                    ],
                    "hint": "It comes from the Greek word for 'motion'."
                }
            ],
            "Chemistry": [
                {
                    "subtopic": "Elements",
                    "question": "What is the most common element in the universe?",
                    "answerOptions": [
                        {"text": "Oxygen", "rationale": "Oxygen is the most common element in Earth's crust, but not the universe.", "isCorrect": false},
                        {"text": "Helium", "rationale": "Helium is the second most common element.", "isCorrect": false},
                        {"text": "Carbon", "rationale": "Carbon is a key component of life, but not the most abundant element overall.", "isCorrect": false},
                        {"text": "Hydrogen", "rationale": "Hydrogen is the most common element, making up over 75% of the universe's mass.", "isCorrect": true}
                    ],
                    "hint": "It is the lightest element on the periodic table."
                },
                {
                    "subtopic": "Compounds",
                    "question": "What is the chemical formula for water?",
                    "answerOptions": [
                        {"text": "CO2", "rationale": "This is carbon dioxide.", "isCorrect": false},
                        {"text": "H2O", "rationale": "Water is a compound made of two hydrogen atoms and one oxygen atom.", "isCorrect": true},
                        {"text": "NaCl", "rationale": "This is table salt.", "isCorrect": false},
                        {"text": "O2", "rationale": "This is oxygen gas.", "isCorrect": false}
                    ],
                    "hint": "It contains hydrogen and oxygen."
                },
                {
                    "subtopic": "Reactions",
                    "question": "What happens in a chemical reaction?",
                    "answerOptions": [
                        {"text": "Elements are destroyed and created.", "rationale": "Elements are neither destroyed nor created in a chemical reaction; they are rearranged.", "isCorrect": false},
                        {"text": "Atoms are rearranged to form new substances.", "rationale": "A chemical reaction involves the breaking of chemical bonds and the formation of new ones, rearranging atoms into new substances.", "isCorrect": true},
                        {"text": "The mass of the substances changes.", "rationale": "The law of conservation of mass states that mass is conserved in a chemical reaction.", "isCorrect": false},
                        {"text": "Substances change their physical state but not their composition.", "rationale": "This describes a physical change, not a chemical reaction.", "isCorrect": false}
                    ],
                    "hint": "A chemical reaction is a process that leads to the chemical transformation of one set of chemical substances to another."
                },
                {
                    "subtopic": "Solutions",
                    "question": "What is a substance that dissolves another substance to form a solution?",
                    "answerOptions": [
                        {"text": "Solute", "rationale": "The solute is the substance that is dissolved.", "isCorrect": false},
                        {"text": "Mixture", "rationale": "A mixture is a combination of two or more substances that are not chemically bonded.", "isCorrect": false},
                        {"text": "Solvent", "rationale": "A solvent is a substance that dissolves a solute to form a solution.", "isCorrect": true},
                        {"text": "Precipitate", "rationale": "A precipitate is a solid that forms from a solution during a chemical reaction.", "isCorrect": false}
                    ],
                    "hint": "Water is a universal example of this substance."
                },
                {
                    "subtopic": "Acids & Bases",
                    "question": "What does a substance with a pH of 2 indicate?",
                    "answerOptions": [
                        {"text": "It is a weak base.", "rationale": "A pH below 7 is acidic.", "isCorrect": false},
                        {"text": "It is a strong acid.", "rationale": "A low pH number (below 7) indicates an acidic substance, with a pH of 2 being a strong acid.", "isCorrect": true},
                        {"text": "It is neutral.", "rationale": "A neutral substance has a pH of 7.", "isCorrect": false},
                        {"text": "It is a strong base.", "rationale": "A strong base has a high pH number, close to 14.", "isCorrect": false}
                    ],
                    "hint": "The pH scale ranges from 0 to 14, with 7 being neutral."
                },
                {
                    "subtopic": "Periodic Table",
                    "question": "Which of the following is a noble gas?",
                    "answerOptions": [
                        {"text": "Chlorine", "rationale": "Chlorine is a halogen.", "isCorrect": false},
                        {"text": "Hydrogen", "rationale": "Hydrogen is in Group 1 of the periodic table.", "isCorrect": false},
                        {"text": "Helium", "rationale": "Helium is an element in Group 18 of the periodic table, known as the noble gases.", "isCorrect": true},
                        {"text": "Sodium", "rationale": "Sodium is an alkali metal.", "isCorrect": false}
                    ],
                    "hint": "This type of gas is known for being non-reactive."
                },
                {
                    "subtopic": "Atomic Structure",
                    "question": "What is the charge of an electron?",
                    "answerOptions": [
                        {"text": "Positive", "rationale": "Protons have a positive charge.", "isCorrect": false},
                        {"text": "Negative", "rationale": "Electrons have a negative charge.", "isCorrect": true},
                        {"text": "Neutral", "rationale": "Neutrons have no charge.", "isCorrect": false},
                        {"text": "Variable", "rationale": "The charge of an electron is constant.", "isCorrect": false}
                    ],
                    "hint": "The name of this particle is related to electricity."
                },
                {
                    "subtopic": "Chemical Bonds",
                    "question": "What type of bond is formed when atoms share electrons?",
                    "answerOptions": [
                        {"text": "Ionic bond", "rationale": "An ionic bond involves the transfer of electrons.", "isCorrect": false},
                        {"text": "Covalent bond", "rationale": "A covalent bond is formed by the sharing of electrons between atoms.", "isCorrect": true},
                        {"text": "Metallic bond", "rationale": "A metallic bond involves a sea of delocalized electrons.", "isCorrect": false},
                        {"text": "Hydrogen bond", "rationale": "A hydrogen bond is a type of intermolecular force.", "isCorrect": false}
                    ],
                    "hint": "The prefix for this type of bond means 'together' or 'jointly'."
                },
                {
                    "subtopic": "States of Matter",
                    "question": "What is the process of a liquid turning into a gas called?",
                    "answerOptions": [
                        {"text": "Condensation", "rationale": "Condensation is a gas becoming a liquid.", "isCorrect": false},
                        {"text": "Sublimation", "rationale": "Sublimation is a solid becoming a gas.", "isCorrect": false},
                        {"text": "Melting", "rationale": "Melting is a solid becoming a liquid.", "isCorrect": false},
                        {"text": "Evaporation", "rationale": "Evaporation is the process of a liquid changing to a gas.", "isCorrect": true}
                    ],
                    "hint": "This is how puddles disappear on a hot day."
                },
                {
                    "subtopic": "Mixtures",
                    "question": "A substance that has a uniform composition throughout is a:",
                    "answerOptions": [
                        {"text": "Heterogeneous mixture", "rationale": "A heterogeneous mixture does not have a uniform composition.", "isCorrect": false},
                        {"text": "Homogeneous mixture", "rationale": "A homogeneous mixture has a uniform composition, also known as a solution.", "isCorrect": true},
                        {"text": "Element", "rationale": "An element is a pure substance, not a mixture.", "isCorrect": false},
                        {"text": "Compound", "rationale": "A compound is a pure substance made of two or more elements.", "isCorrect": false}
                    ],
                    "hint": "Think of salt water. The salt is evenly spread throughout the water."
                },
                {
                    "subtopic": "Stoichiometry",
                    "question": "What is the mole?",
                    "answerOptions": [
                        {"text": "A small mammal that lives underground.", "isCorrect": false},
                        {"text": "A unit of length.", "isCorrect": false},
                        {"text": "A unit of mass.", "isCorrect": false},
                        {"text": "A unit of measurement for the amount of a substance.", "rationale": "The mole is the SI unit for the amount of a substance, defined as containing exactly 6.02214076 x 10^23 elementary entities.", "isCorrect": true}
                    ],
                    "hint": "This unit is often used in chemistry to count atoms or molecules."
                }
            ],
            "Biology": [
                {
                    "subtopic": "Cells",
                    "question": "What is the main function of a cell membrane?",
                    "answerOptions": [
                        {"text": "To produce energy.", "rationale": "Mitochondria produce energy.", "isCorrect": false},
                        {"text": "To control what enters and leaves the cell.", "rationale": "The cell membrane acts as a barrier, controlling the movement of substances in and out of the cell.", "isCorrect": true},
                        {"text": "To store genetic information.", "rationale": "The nucleus stores genetic information.", "isCorrect": false},
                        {"text": "To carry out photosynthesis.", "rationale": "Chloroplasts carry out photosynthesis in plant cells.", "isCorrect": false}
                    ],
                    "hint": "It acts like a gatekeeper for the cell."
                },
                {
                    "subtopic": "Genetics",
                    "question": "What is the study of heredity and the variation of inherited characteristics?",
                    "answerOptions": [
                        {"text": "Ecology", "rationale": "Ecology is the study of organisms and their environment.", "isCorrect": false},
                        {"text": "Anatomy", "rationale": "Anatomy is the study of the structure of living things.", "isCorrect": false},
                        {"text": "Genetics", "rationale": "Genetics is the scientific study of genes and heredity.", "isCorrect": true},
                        {"text": "Physiology", "rationale": "Physiology is the study of the function of living organisms.", "isCorrect": false}
                    ],
                    "hint": "This field of study is named after a unit of heredity."
                },
                {
                    "subtopic": "Ecology",
                    "question": "Which of the following describes an ecosystem?",
                    "answerOptions": [
                        {"text": "A group of individuals of the same species.", "rationale": "This is a population.", "isCorrect": false},
                        {"text": "All the living organisms in a particular area.", "rationale": "This is a community.", "isCorrect": false},
                        {"text": "A community of living organisms interacting with their non-living environment.", "rationale": "An ecosystem includes both biotic (living) and abiotic (non-living) components.", "isCorrect": true},
                        {"text": "A large-scale habitat type.", "rationale": "This is a biome.", "isCorrect": false}
                    ],
                    "hint": "It includes both living things and their non-living surroundings."
                },
                {
                    "subtopic": "Human Body",
                    "question": "What is the function of the human skeletal system?",
                    "answerOptions": [
                        {"text": "Pumping blood.", "rationale": "The heart pumps blood.", "isCorrect": false},
                        {"text": "Producing hormones.", "rationale": "Endocrine glands produce hormones.", "isCorrect": false},
                        {"text": "Providing support and protection for organs.", "rationale": "The skeleton provides the framework for the body and protects internal organs.", "isCorrect": true},
                        {"text": "Digesting food.", "rationale": "The digestive system digests food.", "isCorrect": false}
                    ],
                    "hint": "This system is made of bones and gives your body its shape."
                },
                {
                    "subtopic": "Plants",
                    "question": "In which part of a plant does photosynthesis mainly occur?",
                    "answerOptions": [
                        {"text": "Roots", "rationale": "Roots absorb water and nutrients.", "isCorrect": false},
                        {"text": "Flowers", "rationale": "Flowers are for reproduction.", "isCorrect": false},
                        {"text": "Stems", "rationale": "Stems support the plant and transport water.", "isCorrect": false},
                        {"text": "Leaves", "rationale": "Leaves are the primary site for photosynthesis, as they contain chloroplasts.", "isCorrect": true}
                    ],
                    "hint": "This part of the plant is usually green."
                },
                {
                    "subtopic": "Human Body",
                    "question": "What is the largest organ in the human body?",
                    "answerOptions": [
                        {"text": "Liver", "rationale": "The liver is a very large internal organ, but not the largest overall.", "isCorrect": false},
                        {"text": "Brain", "rationale": "The brain is a vital organ, but much smaller than the skin.", "isCorrect": false},
                        {"text": "Skin", "rationale": "The skin is the largest external organ of the human body, covering an area of approximately 20 square feet.", "isCorrect": true},
                        {"text": "Heart", "rationale": "The heart is a vital organ, but not the largest.", "isCorrect": false}
                    ],
                    "hint": "This organ covers the entire outside of your body."
                },
                {
                    "subtopic": "Cells",
                    "question": "Which type of cell does not have a nucleus?",
                    "answerOptions": [
                        {"text": "Plant cell", "rationale": "Plant cells have a nucleus.", "isCorrect": false},
                        {"text": "Animal cell", "rationale": "Animal cells have a nucleus.", "isCorrect": false},
                        {"text": "Prokaryotic cell", "rationale": "Prokaryotic cells, such as bacteria and archaea, lack a nucleus and other membrane-bound organelles.", "isCorrect": true},
                        {"text": "Eukaryotic cell", "rationale": "Eukaryotic cells have a nucleus.", "isCorrect": false}
                    ],
                    "hint": "This is a simple type of cell, like bacteria."
                },
                {
                    "subtopic": "Ecology",
                    "question": "A producer is an organism that:",
                    "answerOptions": [
                        {"text": "Consumes other organisms for food.", "rationale": "This describes a consumer.", "isCorrect": false},
                        {"text": "Breaks down dead organic matter.", "rationale": "This describes a decomposer.", "isCorrect": false},
                        {"text": "Creates its own food, usually through photosynthesis.", "rationale": "Producers, or autotrophs, create their own food from inorganic sources, typically using sunlight.", "isCorrect": true},
                        {"text": "Moves from one habitat to another.", "rationale": "This describes a migratory organism.", "isCorrect": false}
                    ],
                    "hint": "Think of the first step in a food chain."
                },
                {
                    "subtopic": "Genetics",
                    "question": "What are the building blocks of proteins?",
                    "answerOptions": [
                        {"text": "Carbohydrates", "rationale": "Carbohydrates are a source of energy.", "isCorrect": false},
                        {"text": "Amino acids", "rationale": "Amino acids are the monomers that polymerize to form proteins.", "isCorrect": true},
                        {"text": "Lipids", "rationale": "Lipids are fats and oils.", "isCorrect": false},
                        {"text": "Nucleic acids", "rationale": "Nucleic acids store genetic information.", "isCorrect": false}
                    ],
                    "hint": "There are 20 common types of these, often called the 'A, C, G' of proteins."
                },
                {
                    "subtopic": "Plants",
                    "question": "What is the primary function of a plant's roots?",
                    "answerOptions": [
                        {"text": "To produce flowers.", "rationale": "Flowers are for reproduction.", "isCorrect": false},
                        {"text": "To absorb water and nutrients from the soil.", "rationale": "Roots are the primary site for absorbing water and mineral nutrients from the soil.", "isCorrect": true},
                        {"text": "To produce food through photosynthesis.", "rationale": "Photosynthesis occurs in the leaves.", "isCorrect": false},
                        {"text": "To transport water to the leaves.", "rationale": "The stem transports water.", "isCorrect": false}
                    ],
                    "hint": "This part is underground and helps the plant stay stable."
                }
            ],
            "History": [
                {
                    "subtopic": "Ancient Civilizations",
                    "question": "Which ancient civilization is famous for its invention of writing, known as cuneiform?",
                    "answerOptions": [
                        {"text": "Ancient Egypt", "rationale": "Ancient Egyptians used hieroglyphs.", "isCorrect": false},
                        {"text": "Ancient Greece", "rationale": "Ancient Greeks developed their own alphabet.", "isCorrect": false},
                        {"text": "Mesopotamia", "rationale": "Sumerians in Mesopotamia are credited with inventing cuneiform, one of the earliest systems of writing.", "isCorrect": true},
                        {"text": "Roman Empire", "rationale": "Romans used the Latin alphabet.", "isCorrect": false}
                    ],
                    "hint": "This civilization was located between the Tigris and Euphrates rivers."
                },
                {
                    "subtopic": "World War II",
                    "question": "What event is generally considered the start of World War II in Europe?",
                    "answerOptions": [
                        {"text": "The attack on Pearl Harbor", "rationale": "This event brought the United States into the war.", "isCorrect": false},
                        {"text": "The invasion of Poland by Germany", "rationale": "Germany's invasion of Poland on September 1, 1939, led to Britain and France declaring war, thus starting WWII in Europe.", "isCorrect": true},
                        {"text": "The signing of the Treaty of Versailles", "rationale": "This treaty ended World War I.", "isCorrect": false},
                        {"text": "The assassination of Archduke Franz Ferdinand", "rationale": "This event triggered World War I.", "isCorrect": false}
                    ],
                    "hint": "This happened in September 1939."
                },
                {
                    "subtopic": "Exploration",
                    "question": "Which explorer is credited with the first circumnavigation of the Earth?",
                    "answerOptions": [
                        {"text": "Christopher Columbus", "rationale": "Columbus reached the Americas but did not circumnavigate the globe.", "isCorrect": false},
                        {"text": "Vasco da Gama", "rationale": "Da Gama was the first to sail from Europe to India.", "isCorrect": false},
                        {"text": "Ferdinand Magellan", "rationale": "Ferdinand Magellan's expedition was the first to circumnavigate the Earth, although he did not complete the entire voyage himself.", "isCorrect": true},
                        {"text": "Marco Polo", "rationale": "Marco Polo was a merchant traveler who explored Asia.", "isCorrect": false}
                    ],
                    "hint": "This Portuguese explorer's name is associated with a famous strait."
                },
                {
                    "subtopic": "The Middle Ages",
                    "question": "What was the system of land ownership and social hierarchy during the Middle Ages called?",
                    "answerOptions": [
                        {"text": "Democracy", "rationale": "Democracy is a system of government by the people.", "isCorrect": false},
                        {"text": "Communism", "rationale": "Communism is a political and economic system.", "isCorrect": false},
                        {"text": "Feudalism", "rationale": "Feudalism was the dominant social system in medieval Europe, in which nobles held lands from the Crown in exchange for military service.", "isCorrect": true},
                        {"text": "Capitalism", "rationale": "Capitalism is an economic system based on private ownership.", "isCorrect": false}
                    ],
                    "hint": "This system involved lords, vassals, and peasants."
                },
                {
                    "subtopic": "American Revolution",
                    "question": "Who was the first President of the United States?",
                    "answerOptions": [
                        {"text": "Benjamin Franklin", "rationale": "Benjamin Franklin was a Founding Father, but not a president.", "isCorrect": false},
                        {"text": "Thomas Jefferson", "rationale": "Thomas Jefferson was the third president.", "isCorrect": false},
                        {"text": "George Washington", "rationale": "George Washington was a key leader in the American Revolution and the first president.", "isCorrect": true},
                        {"text": "John Adams", "rationale": "John Adams was the second president.", "isCorrect": false}
                    ],
                    "hint": "His face is on the one-dollar bill."
                },
                {
                    "subtopic": "Ancient Rome",
                    "question": "Who was the first emperor of Rome?",
                    "answerOptions": [
                        {"text": "Julius Caesar", "rationale": "Julius Caesar was a Roman general and statesman, but not an emperor.", "isCorrect": false},
                        {"text": "Augustus", "rationale": "Augustus, born Gaius Octavius, was the first Roman emperor.", "isCorrect": true},
                        {"text": "Nero", "rationale": "Nero was a later Roman emperor.", "isCorrect": false},
                        {"text": "Constantine the Great", "rationale": "Constantine was a Roman emperor who ruled much later than Augustus.", "isCorrect": false}
                    ],
                    "hint": "He was the adopted son of Julius Caesar."
                },
                {
                    "subtopic": "World War I",
                    "question": "What famous treaty officially ended World War I?",
                    "answerOptions": [
                        {"text": "Treaty of Paris", "rationale": "This treaty ended the American Revolutionary War.", "isCorrect": false},
                        {"text": "Treaty of Versailles", "rationale": "The Treaty of Versailles was the peace treaty that officially ended World War I.", "isCorrect": true},
                        {"text": "Treaty of Ghent", "rationale": "This treaty ended the War of 1812.", "isCorrect": false},
                        {"text": "Treaty of Tordesillas", "rationale": "This treaty divided the newly discovered lands outside Europe between Portugal and Spain.", "isCorrect": false}
                    ],
                    "hint": "It was signed in a palace near Paris."
                },
                {
                    "subtopic": "Industrial Revolution",
                    "question": "Which invention greatly improved textile production during the Industrial Revolution?",
                    "answerOptions": [
                        {"text": "The light bulb", "rationale": "The light bulb was invented later.", "isCorrect": false},
                        {"text": "The cotton gin", "rationale": "The cotton gin was invented by Eli Whitney to quickly separate cotton fibers from their seeds.", "isCorrect": true},
                        {"text": "The telephone", "rationale": "The telephone was invented much later.", "isCorrect": false},
                        {"text": "The steam locomotive", "rationale": "The steam locomotive improved transportation, not textile production.", "isCorrect": false}
                    ],
                    "hint": "This invention was related to the process of cleaning cotton."
                },
                {
                    "subtopic": "Exploration",
                    "question": "Who was the first European to sail to India by going around Africa?",
                    "answerOptions": [
                        {"text": "Christopher Columbus", "rationale": "Columbus sailed to the Americas.", "isCorrect": false},
                        {"text": "Ferdinand Magellan", "rationale": "Magellan's expedition circumnavigated the globe.", "isCorrect": false},
                        {"text": "Vasco da Gama", "rationale": "Vasco da Gama was a Portuguese explorer who was the first to sail directly from Europe to India.", "isCorrect": true},
                        {"text": "James Cook", "rationale": "James Cook was a British explorer of the Pacific.", "isCorrect": false}
                    ],
                    "hint": "This explorer was Portuguese."
                },
                {
                    "subtopic": "American History",
                    "question": "What major event is often credited with starting the Great Depression?",
                    "answerOptions": [
                        {"text": "The bombing of Pearl Harbor", "rationale": "This event brought the U.S. into World War II.", "isCorrect": false},
                        {"text": "The assassination of JFK", "rationale": "This event occurred much later in the 20th century.", "isCorrect": false},
                        {"text": "The stock market crash of 1929", "rationale": "The crash of the stock market in October 1929, known as Black Tuesday, is widely seen as the beginning of the Great Depression.", "isCorrect": true},
                        {"text": "The end of World War I", "rationale": "While related, the war's end was not the direct cause of the Great Depression.", "isCorrect": false}
                    ],
                    "hint": "This event happened on a Tuesday in October."
                },
                {
                    "subtopic": "Medieval History",
                    "question": "What was the primary goal of the Crusades?",
                    "answerOptions": [
                        {"text": "To find a new trade route to Asia.", "rationale": "Explorers sought this, but it was not the goal of the Crusades.", "isCorrect": false},
                        {"text": "To conquer new lands in Africa.", "rationale": "The Crusades were primarily focused on the Holy Land.", "isCorrect": false},
                        {"text": "To recapture the Holy Land from Muslim rule.", "rationale": "The Crusades were a series of religious wars initiated by the Latin Church to recover the Holy Land from Islamic rule.", "isCorrect": true},
                        {"text": "To establish a global empire.", "rationale": "This was not the primary goal of the Crusades.", "isCorrect": false}
                    ],
                    "hint": "The name 'crusade' comes from the word for 'cross'."
                }
            ]
        };

        // Function to show a custom message box
        const showMessage = (message) => {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        };

        // Event listener for the close button on the message box
        messageCloseBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        const calculateAverage = (quizzes) => {
            if (quizzes.length === 0) return 0;
            const totalScore = quizzes.reduce((sum, quiz) => sum + quiz.score, 0);
            return totalScore / quizzes.length;
        };

        const renderDashboard = async (myQuizzes) => {
            renderSummary(myQuizzes);
            renderRevisionSuggestions(myQuizzes);
        };

        const renderSummary = (quizzes) => {
            const topics = {};
            quizzes.forEach(quiz => {
                if (!topics[quiz.topic]) {
                    topics[quiz.topic] = { totalScore: 0, count: 0, highestScore: 0, lowestScore: 101, quizzes: [] };
                }
                topics[quiz.topic].totalScore += quiz.score;
                topics[quiz.topic].count++;
                topics[quiz.topic].quizzes.push(quiz);

                if (quiz.score > topics[quiz.topic].highestScore) {
                    topics[quiz.topic].highestScore = quiz.score;
                }
                if (quiz.score < topics[quiz.topic].lowestScore) {
                    topics[quiz.topic].lowestScore = quiz.score;
                }
            });

            summaryContainer.innerHTML = '';
            
            for (const topic in topics) {
                const data = topics[topic];
                const average = data.totalScore / data.count;
                const summaryHtml = `
                    <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700">${topic}</h3>
                        <p class="text-gray-600">Average Score: <span class="font-medium text-lg">${average.toFixed(1)}%</span></p>
                        <p class="text-gray-600">Total Quizzes: ${data.count}</p>
                        <p class="text-gray-600">Highest Score: ${data.highestScore}%</p>
                        <p class="text-gray-600">Lowest Score: ${data.lowestScore}%</p>
                        <div class="mt-4 space-y-2">
                            ${data.quizzes.map((q, index) => `
                                <div class="flex justify-between items-center bg-gray-100 p-2 rounded-lg">
                                    <span class="text-sm text-gray-600">${new Date(q.timestamp).toLocaleString()} (${q.type === 'initial' ? 'Initial' : 'Follow-up'})</span>
                                    <button class="review-past-quiz-btn bg-indigo-500 text-white text-xs font-semibold py-1 px-3 rounded-full hover:bg-indigo-600 transition-colors" data-quiz-index="${quizzes.indexOf(q)}">Review Quiz</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                summaryContainer.innerHTML += summaryHtml;
            }

            // Add event listeners for the review buttons
            document.querySelectorAll('.review-past-quiz-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const quizIndex = e.target.getAttribute('data-quiz-index');
                    if (userProfile.quizzes[quizIndex]) {
                        renderReviewPage(userProfile.quizzes[quizIndex]);
                    }
                });
            });
        };

        const renderRevisionSuggestions = (quizzes) => {
            const incorrectSubtopics = {};
            quizzes.forEach(quiz => {
                if (quiz.attempt) {
                    quiz.attempt.forEach(q => {
                        if (!q.isCorrect) {
                            const subtopic = q.subtopic || 'General';
                            if (!incorrectSubtopics[subtopic]) {
                                incorrectSubtopics[subtopic] = { count: 0, topic: quiz.topic };
                            }
                            incorrectSubtopics[subtopic].count++;
                        }
                    });
                }
            });

            const sortedSubtopics = Object.entries(incorrectSubtopics)
                .map(([name, data]) => ({ name, count: data.count, topic: data.topic }))
                .sort((a, b) => b.count - a.count);

            revisionList.innerHTML = '';
            
            if (sortedSubtopics.length > 0) {
                sortedSubtopics.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = "bg-yellow-100 p-2 rounded-lg border border-yellow-300 shadow-sm";
                    listItem.innerHTML = `<span class="font-medium">${item.name}</span> (${item.topic}) - ${item.count} mistakes`;
                    revisionList.appendChild(listItem);
                });
            } else {
                revisionList.innerHTML = '<li class="text-yellow-700">No topics are currently flagged for revision. Great job!</li>';
            }
        };

        const handleAuthAndProfile = async (user) => {
            if (user) {
                console.log("User authenticated:", user.uid);
                userId = user.uid;
                userProfileRef = doc(db, `artifacts/${appId}/public/data/students/${userId}`);
                
                const userDoc = await getDocs(query(collection(db, `artifacts/${appId}/public/data/students`), where('userId', '==', userId)));
                
                if (userDoc.docs.length > 0) {
                    console.log("Profile found.");
                    userProfile = userDoc.docs[0].data();
                    welcomeName.textContent = `Welcome, ${userProfile.name}!`;
                    welcomeClass.textContent = `(Class: ${userProfile.class})`;
                    loginSection.classList.add('hidden');
                    trackerSection.classList.remove('hidden');
                    startDataListener();
                } else {
                    console.log("Profile not found, showing login.");
                    loginSection.classList.remove('hidden');
                    trackerSection.classList.add('hidden');
                    authStatus.textContent = "Authenticated. Enter your details to start.";
                }
            } else {
                console.log("No user authenticated. Signing in.");
                loginSection.classList.remove('hidden');
                trackerSection.classList.add('hidden');
                authStatus.textContent = "Not authenticated. Attempting anonymous sign-in.";
                try {
                     if (initialAuthToken) {
                         await signInWithCustomToken(auth, initialAuthToken);
                     } else {
                         await signInAnonymously(auth);
                     }
                } catch(error) {
                    console.error("Error during initial sign-in:", error);
                    authStatus.textContent = "Authentication failed.";
                }
            }
        };

        onAuthStateChanged(auth, handleAuthAndProfile);

        loginBtn.addEventListener('click', async () => {
            const name = studentNameInput.value.trim();
            const className = classNameInput.value.trim();
            
            if (!name || !className) {
                showMessage("Please enter both your name and class.");
                return;
            }

            try {
                userProfile = { name, class: className, quizzes: [], userId: userId };
                await setDoc(userProfileRef, userProfile);
                
                welcomeName.textContent = `Welcome, ${userProfile.name}!`;
                welcomeClass.textContent = `(Class: ${userProfile.class})`;
                loginSection.classList.add('hidden');
                trackerSection.classList.remove('hidden');
                startDataListener();
            } catch (error) {
                console.error("Error logging in: ", error);
                showMessage("Failed to log in. Please try again.");
            }
        });
        
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error logging out: ", error);
                showMessage("Failed to log out. Please try again.");
            }
        });

        const startDataListener = () => {
            onSnapshot(userProfileRef, (doc) => {
                if (doc.exists()) {
                    userProfile = doc.data();
                    const quizzes = userProfile.quizzes || [];
                    renderDashboard(quizzes);
                } else {
                     showMessage("Your profile data was not found. Please log in again.");
                     signOut(auth);
                }
            });
        };

        topicInput.addEventListener('change', () => {
            if (topicInput.value) {
                startQuizBtn.disabled = false;
            } else {
                startQuizBtn.disabled = true;
            }
        });
        
        startQuizBtn.addEventListener('click', () => {
            currentQuizTopic = topicInput.value;
            if (!currentQuizTopic) {
                showMessage("Please select a topic to start a quiz.");
                return;
            }

            trackerSection.classList.add('hidden');
            quizSection.classList.remove('hidden');
            renderQuiz(currentQuizTopic);
        });

        const renderQuiz = (topic) => {
            const questions = quizData[topic];
            if (!questions) {
                showMessage("Quiz questions for this topic are not available.");
                return;
            }
            
            quizTopicTitle.textContent = `${topic} Quiz`;
            quizForm.innerHTML = '';
            quizResults.classList.add('hidden');
            currentQuizAttempt = [];

            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-md';
                questionDiv.innerHTML = `
                    <p class="text-xl font-semibold text-gray-800 mb-4">${index + 1}. ${q.question}</p>
                    <div class="space-y-3">
                        ${q.answerOptions.map((option, optionIndex) => `
                            <label class="flex items-center p-3 rounded-lg border border-gray-300 cursor-pointer hover:bg-white transition-colors">
                                <input type="radio" name="question-${index}" value="${option.text}" class="mr-3" data-is-correct="${option.isCorrect}">
                                <span class="text-gray-700">${option.text}</span>
                            </label>
                        `).join('')}
                    </div>
                    <p id="hint-text-${index}" class="text-sm text-gray-500 mt-4 hidden">${q.hint}</p>
                    <button type="button" class="show-hint-btn text-blue-500 hover:text-blue-700 text-sm mt-2 focus:outline-none" data-index="${index}">Show Hint</button>
                `;
                quizForm.appendChild(questionDiv);
            });

            // Add submit button
            const submitBtn = document.createElement('button');
            submitBtn.id = 'submitQuizBtn';
            submitBtn.type = 'submit';
            submitBtn.textContent = 'Submit Quiz';
            submitBtn.className = 'w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 mt-6';
            quizForm.appendChild(submitBtn);

            quizForm.addEventListener('click', (e) => {
                if (e.target.classList.contains('show-hint-btn')) {
                    const index = e.target.getAttribute('data-index');
                    const hintElement = document.getElementById(`hint-text-${index}`);
                    if (hintElement) {
                        hintElement.classList.remove('hidden');
                        e.target.style.display = 'none';
                    }
                }
            });

            quizForm.addEventListener('submit', (e) => {
                e.preventDefault();
                let score = 0;
                currentQuizAttempt = questions.map((q, index) => {
                    const selected = document.querySelector(`input[name="question-${index}"]:checked`);
                    const isCorrect = selected ? selected.dataset.isCorrect === 'true' : false;
                    if (isCorrect) {
                        score++;
                    }
                    return {
                        ...q,
                        isCorrect: isCorrect,
                        userAnswer: selected ? selected.value : null
                    };
                });
                
                currentQuizScore = (score / questions.length) * 100;
                quizScoreDisplay.textContent = `${currentQuizScore.toFixed(0)}%`;
                
                quizForm.classList.add('hidden');
                quizResults.classList.remove('hidden');
            }, { once: true });
        };

        const renderReviewPage = (quizData) => {
            quizSection.classList.add('hidden');
            trackerSection.classList.add('hidden');
            reviewSection.classList.remove('hidden');
            reviewTitle.textContent = `Review Quiz`;
            reviewContentContainer.innerHTML = '';
            
            const incorrectQuestions = quizData.attempt.filter(q => !q.isCorrect);

            if (incorrectQuestions.length > 0) {
                incorrectQuestions.forEach((q, index) => {
                    // Create a section for the incorrect question and its mini-quiz
                    const mistakeBlock = document.createElement('div');
                    mistakeBlock.className = "mb-8";
                    
                    // Add the incorrect question details
                    const mistakeHtml = `
                        <div class="bg-red-50 p-6 rounded-lg border border-red-200 shadow-md mb-6">
                            <p class="text-lg font-semibold text-red-800 mb-2">Question: ${q.question}</p>
                            <p class="text-sm text-gray-700">Your Answer: <span class="font-medium text-red-600">${q.userAnswer || 'No answer selected'}</span></p>
                            <p class="text-sm text-gray-700">Correct Answer: <span class="font-medium text-green-600">${q.answerOptions.find(opt => opt.isCorrect).text}</span></p>
                            <p class="text-sm text-gray-600 mt-2"><span class="font-semibold">Explanation:</span> ${q.answerOptions.find(opt => opt.isCorrect).rationale}</p>
                        </div>
                    `;
                    mistakeBlock.innerHTML += mistakeHtml;

                    // Add a heading for the follow-up quiz
                    const followUpHeading = document.createElement('h3');
                    followUpHeading.className = "text-xl font-bold text-gray-800 mb-4";
                    followUpHeading.textContent = `Follow-up Questions for Question ${index + 1}`;
                    mistakeBlock.appendChild(followUpHeading);

                    // Create the follow-up quiz form
                    const followUpForm = document.createElement('form');
                    followUpForm.className = "space-y-6 mb-6";
                    followUpForm.setAttribute('data-index', index);
                    
                    generateFollowUpQuiz(quizData.topic, q.question, followUpForm, index);

                    mistakeBlock.appendChild(followUpForm);
                    reviewContentContainer.appendChild(mistakeBlock);
                });
            } else {
                reviewContentContainer.innerHTML = '<p class="text-center text-green-700 font-medium">You got all questions correct! No mistakes to review.</p>';
            }
        };

        const generateFollowUpQuiz = (topic, incorrectQuestionText, formElement, blockIndex) => {
            const allQuestions = quizData[topic];
            
            const availableQuestions = allQuestions.filter(q => q.question !== incorrectQuestionText);
            
            const shuffledQuestions = availableQuestions.sort(() => 0.5 - Math.random());
            const followUpQuestions = shuffledQuestions.slice(0, 5);

            if (followUpQuestions.length < 5) {
                formElement.innerHTML = `<p class="text-center text-gray-600">Not enough new questions available for a full follow-up quiz. Please try a different topic.</p>`;
                return;
            }

            followUpQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-md';
                questionDiv.innerHTML = `
                    <p class="text-xl font-semibold text-gray-800 mb-4">${index + 1}. ${q.question}</p>
                    <div class="space-y-3">
                        ${q.answerOptions.map((option) => `
                            <label class="flex items-center p-3 rounded-lg border border-gray-300 cursor-pointer hover:bg-white transition-colors">
                                <input type="radio" name="follow-up-question-${blockIndex}-${index}" value="${option.text}" class="mr-3" data-is-correct="${option.isCorrect}">
                                <span class="text-gray-700">${option.text}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
                formElement.appendChild(questionDiv);
            });
            
            const submitBtn = document.createElement('button');
            submitBtn.type = 'submit';
            submitBtn.textContent = 'Submit Follow-up Quiz';
            submitBtn.className = 'w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 mt-6';
            formElement.appendChild(submitBtn);

            formElement.addEventListener('submit', async (e) => {
                e.preventDefault();
                let score = 0;
                const followUpAttempt = followUpQuestions.map((q, index) => {
                    const selected = formElement.querySelector(`input[name="follow-up-question-${blockIndex}-${index}"]:checked`);
                    const isCorrect = selected && selected.dataset.isCorrect === 'true';
                    if (isCorrect) {
                        score++;
                    }
                    return {
                        ...q,
                        isCorrect: isCorrect,
                        userAnswer: selected ? selected.value : null
                    };
                });

                const finalScore = (score / followUpQuestions.length) * 100;

                const newQuiz = {
                    topic: topic,
                    score: finalScore,
                    timestamp: new Date().toISOString(),
                    type: 'follow-up',
                    attempt: followUpAttempt
                };
                userProfile.quizzes = userProfile.quizzes || [];
                userProfile.quizzes.push(newQuiz);
                await setDoc(userProfileRef, userProfile);

                const resultDiv = document.createElement('div');
                resultDiv.className = "mt-4 text-center p-4 rounded-lg shadow-md bg-green-100";
                resultDiv.innerHTML = `<p class="text-lg font-semibold text-green-700">Follow-up Score: <span class="font-bold">${finalScore.toFixed(0)}%</span></p>`;
                formElement.parentNode.insertBefore(resultDiv, formElement.nextSibling);
                formElement.remove();
            });
        };


        // Event Listeners
        backToDashboardBtn.addEventListener('click', () => {
            quizSection.classList.add('hidden');
            trackerSection.classList.remove('hidden');
            topicInput.value = '';
            startQuizBtn.disabled = true;
        });

        backFromReviewBtn.addEventListener('click', () => {
            reviewSection.classList.add('hidden');
            trackerSection.classList.remove('hidden');
            topicInput.value = '';
            startQuizBtn.disabled = true;
        });

        reviewMistakesBtn.addEventListener('click', () => {
            const currentFullQuizAttempt = { 
                topic: currentQuizTopic, 
                attempt: currentQuizAttempt 
            };
            renderReviewPage(currentFullQuizAttempt);
        });

        saveScoreBtn.addEventListener('click', async () => {
            try {
                const newQuiz = {
                    topic: currentQuizTopic,
                    score: currentQuizScore,
                    timestamp: new Date().toISOString(),
                    type: 'initial',
                    attempt: currentQuizAttempt
                };
                userProfile.quizzes = userProfile.quizzes || [];
                userProfile.quizzes.push(newQuiz);
                await setDoc(userProfileRef, userProfile);
                
                showMessage(`Quiz result saved successfully! Your score for ${currentQuizTopic} was ${currentQuizScore.toFixed(0)}%.`);
                
                quizSection.classList.add('hidden');
                trackerSection.classList.remove('hidden');
                topicInput.value = '';
                startQuizBtn.disabled = true;
            } catch (error) {
                console.error("Error adding quiz result: ", error);
                showMessage("Failed to save quiz result. Please try again.");
            }
        });
    </script>
</body>
</html>
